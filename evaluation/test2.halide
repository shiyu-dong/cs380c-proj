#include <Halide.h>
#define RESULT_TYPE double
using namespace Halide;

int main(int argc, char **argv) {

  const int size = 1024;

  //input
  Image<double> input(size, size);
  for (int i = 0; i < size; i++) {
    for (int j = 0; j < size; j++) {
      input(j,i) = (double)rand() / RAND_MAX;
    }
  }

  Func blur_x(x[1],y), blur_y(x,y[1]), blur_all(x[1], y[1]);
  Var x, y;

  // The algorithm
  blur_x(x, y) = (input(x-1, y) + input(x, y) + input(x+1, y))/3;
  blur_y(x, y) = (blur_x(x, y-1) + blur_x(x, y) + blur_x(x, y+1))/3;
  blur_all(x, y) = (blur_y(x-1, y) + blur_y(x, y-1) + blur_y(x+1, y) + blur_y(x, y+1) + blur_y(x-1, y-1) + blur_y(x-1, y+1) + blur_y(x+1, y+1) + blur_y(x+1, y-1))/8;

  // The schedule
  blur_x.tile(x, xTile, 128, y, yTile, 128);
  blur_x.vectorize();
  blur_x.parallel(xTile);

  blur_y.tile(x, xTile, 128, y, yTile, 128);
  blur_y.vectorize();
  blur_y.parallel(yTile);

  blur_all.tile(x, xTile, 128, y, yTile, 128);
  blur_all.vectorize();
  blur_all.parallel(yTile);

  //output
  Image<double> output = blur_all.realize(size, size);
  for (int i = 0; i < size; i++) {
    for (int j = 0; j < size; j++) {
      printf("%f ", output(j, i));
    }
    printf("\n");
  }

  return 0;
}
